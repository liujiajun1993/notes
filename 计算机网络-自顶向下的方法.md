(注：特别重要的部分使用article标签包裹)

## 一、概论
1. 交换式网络
  - 电路交换网络
  - 分组交换网络

2. 协议分层
  - 优点：将服务从实现中分离出来。例如如果需要修改或更换应用层协议，只需要修改相应的应用层设备即可

3. TCP/IP协议簇
   ![](https://raw.githubusercontent.com/liujiajun1993/notes/master/images/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C1-1.png)
   主机间通信方法, 注意交换机和路由器的区别。路由器涉及多个数据链路层和物理层的结合，因此需要更高一层的网络层。![主机间通信方法](https://raw.githubusercontent.com/liujiajun1993/notes/master/images/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C1-2.png)
   应用层、传输层、网络层属于端对端（end-to-end），而数据链路层和物理层属于点对点（hop-to-hop），必须经过一个主机或者一个路由器一步一步传递。
   1. 应用层，进程之间的通信，HTTP/SMTP/FTP/TELNET/SSH/DNS...
   2. 传输层，向应用层提供服务，将应用层信息投递到目标主机。TCP/UDP/SCTP(流控制传输协议)
   3. 网络层，在院计算机和目标计算机之间创建一个连接。IP/DHCP/ARP（地址解析协议）/ICMP（因特网控制报文协议）/IGMP（因特网组管理协议）
   4. 数据链路层，将数据包封装在frame（帧）中
   5. 物理层。携带frame中的bit穿过链路

4. 封装和解封装
  应用层message -> 传输层segment(TCP)/user datagram(UDP) -> 网络层(datagram, 添加自己的头部) -> 数据链路层(frame, 添加自己的头部) -> 物理层

5. 地址
  每一层协议（除了物理层）都需要地址来对应通信的双方。
  传输层的地址对应端口号，网络层地址对应网络IP，链路层地址对应MAC地址。链路层地址用于在网络中定义一个特定的主机或者路由器。

6. OSI模型（注意是模型不是协议）
  ![OSI七层模型](https://raw.githubusercontent.com/liujiajun1993/notes/master/images/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C1-3.png)
  相对于TCP/IP协议簇，多了会话层和表示层，一般认为TCP/IP的应用层包含了它们
  OSI模型最终并没有替代TCP/IP协议簇

----------
## 二、应用层
  TCP/IP协议簇的层次结构是的因特网比其他网络诸如电话网络、广播网络更灵活，只需要加入新的协议就可以支持新的服务。

### 2.1 客户-服务器模式
   应用层与操作系统（操作系统封装了之后的四层接口）的通信通过API接口实现。包括套接字接口（socket），传输层接口（Transport Layer Interface, TLI)以及STREAM。
   套接字地址 = IP地址 + 端口号

   **URI** = 协议 + 主机 + 端口 + 路径

   <mark>万维网</mark>是无数个网络站点和网页的集合，它们在一起构成了<mark>因特网</mark>最主要的部分（因特网也包括电子邮件、Usenet以及新闻组）。它实际上是多媒体的集合，是由<mark>超级链接 (hyper)</mark>连接而成的。
   万维网和互联网的区别，互联网是通过电缆将计算机连接起来的物理网络，万维网是建立在互联网上的虚拟网络，用于提供超文本服务。

   <mark>超文本传输协议(HTTP)</mark>定义客户服务器如何从万维网获取网页的协议。使用TCP服务，在客户和服务器进行任何事务之前，必须建立连接。

   **持续连接**一次TCP连接可以响应多次请求

   **HTTP请求报文**
   ![请求报文和响应报文格式](https://raw.githubusercontent.com/liujiajun1993/notes/master/images/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C2-1.png)
   ![请求头部](https://raw.githubusercontent.com/liujiajun1993/notes/master/images/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C2-2.png)
   ![响应头部](https://raw.githubusercontent.com/liujiajun1993/notes/master/images/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C2-3.png)

   **请求条件**缓存的四种条件，参考[浏览器缓存知识小结及应用](http://www.cnblogs.com/lyzg/p/5125934.html)或印象笔记中的剪藏：
   - Expires，对比时间
   - Cache-Control,设置max-age=毫秒数
   - Last-Modified/If-Modified-Since
   - Etag/If-None-Match

   **Cookie**

   **代理服务器**代理服务器是一台计算机，能够保存最近请求的响应副本。如果没有命中缓存，就向响应的服务器发送请求。
   代理服务器既是一个服务器又是一个客户。

   **HTTP安全**HTTPS提供保密性、客户和服务器鉴别，以及数据完整性保证。

   <em>FTP</em>更适用于传输大文件或者使用不同格式传送文件。
   ![FTP传输过程](https://raw.githubusercontent.com/liujiajun1993/notes/master/images/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C2-4.png)
   注意FTP的控制进程和数据传输进程是**分开的**。*21端口*用于控制链接，*20端口*用于数据连接。整个FTP会话过程中，控制连接始终处于连接状态，当文件传输命令执行时，数据连接就打开，传输完毕就关闭。
   FTP的数据传输进程略。
   安全的FTP建立在SSL层上，成为SSL-FTP。

   <em>SMTP</em>定义MTA客户机和服务器之间的常用协议。用于邮件的发送。
   ![邮件发送过程](https://raw.githubusercontent.com/liujiajun1993/notes/master/images/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C2-5.png)
   邮件传输过程：连接建立（服务器返回代码220->客户发送HELO报文->服务器返回250）、邮件传输、连接终止（服务器返回221）

   <em>POP/IMAP</em>SMTP定义发送邮件(push)的协议，pull阶段使用报文访问代理协议，一般有两种，分别为POP3和IMAP4。
   相对而言，IMAP4更复杂，但功能更多。

   <em>MIME</em>多用途因特网邮件扩充，允许非ASCII数据通过电子邮件传送。

   <em>TELNET</em>，用于远程登录。考虑到安全问题，升级为SSH。
   ![远程登录流程](https://raw.githubusercontent.com/liujiajun1993/notes/master/images/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C2-6.png)

   <em>SSH</em>
   ![SSH组件](https://raw.githubusercontent.com/liujiajun1993/notes/master/images/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C2-6.png)
   SSH传输层协议建立在TCP协议上，建立安全信道，保证保密性、数据完整性、服务认证和报文压缩。
   SSH认证协议让服务器认证客户。
   SSH连接协议用于通信逻辑。

   <em>DNS</em>
   ![DNS名字服务器](https://raw.githubusercontent.com/liujiajun1993/notes/master/images/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C2-7.png)

### 2.2 对等模式（P2P模式）
   不需要一个不断运行并等待客户进程连接的服务器进程。（迅雷。。。）
   一个对等节点既可以是客户，也可以是服务器。
   对等模式，当网络中一个对等节点有文件要共享，那么它使其他对等节点都能获得这个文件。

   **P2P网络**
   集中式P2P网络，使用客户-服务器模式，但是文件存储和下载使用对等模式完成。对等节点现在中心服务器进行注册，提供要分享的文件列表。
   分散式P2P网络，对等节点将自身置于覆盖网中，按照节点连接方式又分为非结构化分散式P2P网络和结构化分散式P2P网络。非结构化中，节点随机连接，搜索效率不高。结构化网络采用一组阈限确定的规则连连接节点，有效并高效地解决查询。

   **分布式散列表（DHT）**
   按预先定义的规则将数据分发到一组节点上。（利用散列表可以直接获得要查询的数据的存储节点）
   ![DHT查询方法](https://raw.githubusercontent.com/liujiajun1993/notes/master/images/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C2-9.png)

### 2.3 套接字接口编程
套接字只起到一个引用或标签的作用，既不能发送也不能接收数据。
套接字结构的<mark>五个字段</mark>：
   - 族（协议簇，通常是PF_INET/PF_INET6）
   - 类型（SOCK_STREAM用于TCP，SOCK_DGRAM用于UDP，SOCK_SEQPACKET用于，SOCK_RAW用于ISP服务）
   - 协议。定义族中特定协议，对于TCP/IP字段设为0
   - 本地套接字地址，一个结构，由长度字段、族字段、端口号字段以及IP地址字段构成。本地端口号一般是临时端口号。
   - 远程套接字地址。远程端口号一般是约定俗成的特定端口号。

  **UDP通信流程**  客户和服务器每一端都只使用一个套接字。服务器端的套接字永远运行。
  ![UDP通信流程](https://raw.githubusercontent.com/liujiajun1993/notes/master/images/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C2-10.png)
  （咦，代码跟深入了解计算机系统里好像。。。）

  **TCP通信**  面向连接的协议。服务器使用*两个*套接字，一个用于建立（监听套接字）一个用于传输。客户只使用一个套接字用于连接以及数据交换。
  ![TCP通信流程](https://raw.githubusercontent.com/liujiajun1993/notes/master/images/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C2-11.png)

------
## 三、传输层
因特网上从一点到另一个点传输数据的端到端逻辑传输媒介。
### 3.1 介绍
传输层提供进程到进程的通信，进程是传输层服务的应用层实体。
网络层提供主机到主机的通信，投递到正确的进程需要传输层协议。
![网络层与传输层的作用区别](https://raw.githubusercontent.com/liujiajun1993/notes/master/images/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C3-1.png)

IP地址在全世界范围确定一个主机，而端口号在该主机上确定特定的进程
![IP地址和端口号的作用](https://raw.githubusercontent.com/liujiajun1993/notes/master/images/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C3-2.png)

<br>
熟知端口号存储在/etc/services文件中，每行给出服务器名和熟知端口号
![ICANN端口号编码范围](https://raw.githubusercontent.com/liujiajun1993/notes/master/images/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C3-3.png)

**封装与解封装
封装：传输层从应用层接收数据并加入传输层头部。
解封装：报文到达后头部被丢弃，将报文传递给应用层。**

**流量控制**
当服务器推数据时，可能存在消费者被淹没的情况，因此需要流量控制来通知生产者停止传递，并在准备好接收数据时通知生产者。
通常采用<mark>两个缓冲区</mark>，分别位于发送方的传输层（发送方的应用层和传输层）和接收方的传输层（发送方的传输层和接收方的传输层）。

**差错控制**
IP层不可靠，如果应用层需要可靠性，需要由传输层来变得可靠。这是通过在传输层加入差错控制服务来实现。
差错控制主要负责以下几个方面：
  1. 发现并丢弃被破坏的分组
  2. 记录丢失和丢弃的分组并重传
  3. 识别重复分组并丢弃
  4. 缓冲时序分组知道丢失的分组到达

差错控制仅存在于发送方和接收方的传输层之间。
在传输层分组（packet）中加入一个字段来保存<mark>序号</mark>。接收方传输层可以通知发送方传输层利用序号重传分组或者实现去重、重排失序。
接收方在收到正确的分组之后发送一个<mark>确认信号</mark>。发送方在发送一个分组后就开启一个计时器，如果超时没有收到确认信号，就重发。

**流量控制和差错控制的组合**
发送端： 分组准备发送，采用下一个缓冲区空闲位置号码x作为分组的序号。当分组发送时，一个分组的备份存储在内存位置x，等待来自另一端的确认。当确认到达，分组被清除，内存位置空闲出来。
接收端：当带有序号y的分组到达时，被存储在内存位置y上，直到应用层准备好接受它。这是发送一个确认表明分组y已经到达。

**无连接服务**。传输层将数据块看做彼此没有关系的单元。流量控制、差错控制和拥塞控制都不能在无连接服务中有效实现。
**面向连接服务**。传输层的面向连接服务仅涉及两个主机，与网络层的面向连接服务（两个主机及中间的所有路由器都需要协调）不同。

### 3.2 传输层协议

<em>简单协议</em>。简单的无连接协议，不使用任何控制。（真的不能再简单了。。。。）

<em>停止-等待协议</em>。使用流量和差错控制。发送方和接收方都是用大大小为1的滑动窗口（缓冲区）。发送方发送一个分组就开始等待确认，确认到达后再发送下一个分组。
带宽利用率非常低。
带宽延迟乘积 = 带宽 乘以 信号往返时间。

<em>回退N帧协议</em>。为了提高效率，等待确认时可以传输多个分组。发送多个分组，但接收方的缓冲区只能接受一个分组。任何失序的分组到达都会被丢弃。
![回退N帧协议的发送窗口滑动过程](https://raw.githubusercontent.com/liujiajun1993/notes/master/images/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C3-4.png)

<em>选择性重复协议</em>。发送窗口更小（大小为2^(m-1)，即如果序号是0-15，那么发送滑动窗口的大小为8），但是接受窗口和发送窗口大小一致。因此失序分组不需要被丢弃，只需要重新发送丢失分组即可（选择性重复）。
![选择性重复协议的发送窗口滑动过程](https://raw.githubusercontent.com/liujiajun1993/notes/master/images/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C3-5.png)

<em>双向协议：捎带</em>。之前的协议都是单向的，数据分组只沿这一个方向流动，确认也是按一个方向传递。而现实中数据分组通常是双向流动的。当一个分组携带数据从A到B，也携带了确认反馈，确认了来自B的分组已经到达。

![TCP/IP协议簇中传输层协议的位置](https://raw.githubusercontent.com/liujiajun1993/notes/master/images/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C3-6.png)

### 3.3 用户数据报协议（UDP）
无连接不可靠传输层协议。
优点：非常简单，开销小。
缺点：只能提供非常有限的差错检验。

<em>用户数据报（user datagram）</em>
![用户数据报格式](https://raw.githubusercontent.com/liujiajun1993/notes/master/images/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C3-7.png)
注意UDP只记录端口号。主机定位是由网络层完成。

无连接的结果就是，使用UDP的进程不能向UDP发送数据流，同时，每个请求必须足够小使能够装入用户数据报中（小于65507字节）。

UDP不提供流量控制、差错控制、拥塞控制，如果需要，使用UDP的进程应该自己提供这个服务。

<mark>校验和</mark>:请见第五章。。。。

### 3.4 传输控制协议（TCP）
TCP是一个面向流的协议。

TCP使用<>字节流</span>传送数据，但是IP使用<span>分组</span>方式而非字节流。因此在传输层，TCP将多个字节组合在一起成为一个分组，称为段（segment），给每个段添加头部，并将该段传递给IP层。

TCP是全双工通信，数据可以在同一时间双向流动。每个方向都有TCP的发送和接受缓冲区。

<mark>字节序号</mark>。TCP为所有传输<span>字节</span>编号，第一个字节的序号是一个随机值。
字节被编号后，TCP对发送的每一个<span>段</span>分配一个序号，这个序号对应段中的第一个字节的序号。

<mark>确认号</mark>。确认号定义了通信一方预期接受的下一个字节（例如现在已经接受了5362，那么确认号应该是5363）

<br>
![TCP段格式](https://raw.githubusercontent.com/liujiajun1993/notes/master/images/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C3-8.png)
注意头部规定了确认号

![TCP段中的控制字段](https://raw.githubusercontent.com/liujiajun1993/notes/master/images/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C3-9.png)

<em>TCP连接</em>
TCP在较高层次上操作，使用IP服务向接收方传递独立的段，但他控制链接本身。如果段丢失或者损坏，就重新发送它。IP并不知道这个过程。
接下来介绍：连接建立、数据传输和连接终止三个过程
1. <span>连接建立</span>
  <article>**三次握手**
  ![三次握手过程](https://raw.githubusercontent.com/liujiajun1993/notes/master/images/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C3-10.png)
    1. 客户发送第一个段<span>SYN</span>。SYN段是一个控制端并且不携带数据，然而它消耗一个序号，因为需要被确认。
    2. 服务器发送第二个段，<span>SYN + ACK段</span>。SYN段用于给从服务器发送的字节编号，ACK用于告诉客户服务器端的确认号。（是否可以这样理解，SYN是客户端定义的确认号，ACK是服务器定义的确认号）
    3. 客户发送第三个段，仅含<span>ACK段</span>，用于向服务器确认收到第二个段。

  SYN泛洪攻击。伪造大量源IP地址发送SYN段，服务器消耗大量资源等待第三步ACK段确认，最终耗尽资源而崩溃。SYN泛洪攻击数据DOS攻击的一种。
  对于这种攻击，可以在特定的时间周期对连接请求进行限制，也可以过滤掉来自不需要的原地址的数据报。SCTP则采用cookie推迟资源分配知道一个完整的连接建立。
</article>

2. <span>数据传输</span>
  ![数据传输过程](https://raw.githubusercontent.com/liujiajun1993/notes/master/images/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C3-11.png)
  注意ack号用于确认。
  **PSH标志**用于告诉接收端的TCP，该段数据必须尽快传递给接受进程，而不需要等待缓冲器填满。一般情况下，接收端TCP都会等待缓冲区填满之后再传递数据给接收进程。
  **URG标志**告知接收端这是紧急数据，但并不享受优先服务，如何处理紧急数据由应用程序决定。

3. <span>连接终止</span>
  方法一： 三次握手
  1. 客户TCP发送FIN段
  2. 服务器发送FIN + ACK
  3. 客户发送ACK段（接收到的服务器FIN段序号 + 1）

  方法二：半关闭四次握手
  一端停止发送数据之后，还可以持续接收数据。即半关闭。
  1. 客户端发送FIN实现半关闭
  2. 服务器发送ACK段确认半关闭
  3. 服务器继续发送数据，直到完毕。然后发送FIN段
  4. 客户端发送ACK段，连接关闭。

**RST标志**表示连接重置

<em>流量控制</em>。当接收方的窗口已满，简单地拒绝发送方TCP数据。接收方通过发送rwnd字段告知窗口剩余大小

<em>差错控制</em>。检测并重发损坏段、重发丢失段、存储失序段直到正确段到达、检测并丢弃重复段。
主要通过三种工具完成：校验和、确认和超时。
**重传**当重传计时器超时，或当发送方接收到对队列中第一个段的三次重复ACK时，就重传这个段（快速重传）
<div style="text-align: center">
![重传情况一：段丢失](https://raw.githubusercontent.com/liujiajun1993/notes/master/images/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C3-12.png)
段丢失示例
![重传情况二：三次收到重复ACK](https://raw.githubusercontent.com/liujiajun1993/notes/master/images/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C3-13.png)
三次收到重复ACK示例（即四次相同的ACK）
</div>

以选择性重复协议为模型对TCP进行描述效果最好。

<em>拥塞控制</em>在流量控制中，接收方使用<span>接受窗口rwnd</span>的数值来控制发送窗口。但是中间缓冲区、路由器缓冲可能变得拥塞。TCP使用<span>拥塞窗口 (cwnd) </span>的变量来控制段的发送数量。
拥塞检测：超时（严重拥塞）或接收到三次重复ACK信号（轻微拥塞）。
<span>拥塞策略</span>
  - 慢启动：最大段长度（MSS） = minimum(cwnd, rwnd)。发送窗口大小将按指数级增大，直到一个阈值。（例如最开始窗口大小为1，收到确认之后变为2，再变为4，...）。然后重新开始下一个阶段。
  - 拥塞避免：将上面指数式增大变为线性增加，（从1变为2变为3，...）。这种情况下，窗口大小一直增大直到遇到拥塞，不存在阈值。
  - 快速恢复：仅当重复ACK到达时，增加拥塞窗口大小。

三种策略之间可以按照一定条件相互转化，从而不断动态调整拥塞窗口的大小。

<em>TCP计时器</em>。绝大多数TCP实现至少四种计时器：重传、坚持、保活和时间等待计时器。
<span>重传计时器</span>。用于超时重传。首先需要计算往返时间（RTT）
<span>坚持计时器</span>。接收TCP声明0窗口大小（暂停接收新数据），发送TCP停止传输，直到接收TCP发送一个ACK段声明非零窗口大小。这个ACk段可能丢失，从而两端相互等待产生死锁。因此，发送方收到窗口大小为0的确认时，开启坚持计时器。到时之后，发送方TCP发送一个特殊的段（探测，probe），接收方TCP收到后重发确认。
<span>保活计时器</span>。用来防止TCP长期空闲连接。服务器收到一次数据就重置计时器，到时之后发送探测端，10次无响应则终止连接。
<span>时间等待计时器</span>。当TCP执行主动关闭并发送最后一个ACK时，连接保持一段时间，从而允许TCP重发最后一个ACK，以防丢失。

---------------
## 四、网络层
### 4.1 介绍
<em>网络层服务</em>
<span>分组</span>:源端将负载封装进网络层分组并且在目的端从网络层分组中解封。源主机从上层协议（传输层）中接收分组、加入头部；源端不可以改变负载的内容，除非负载过大才需要分段。目的主机从数据链路层接受分组，解封并将负载上传到上层协议。
<span>路由</span>：网络层负载寻找最佳路由。通过运行<span>路由协议</span>来帮助路由器协调关于邻居的只是，并提出当分组到达时使用的一致性表格。
<span>转发</span>：当分组到达路由器的一个端口时，路由器所采用的行为。路由器采用决策表（转发表）来实施行为。接收到分组后，路由器需要将分组转发到另一个或多个所连接的网络上。
![转发过程](https://raw.githubusercontent.com/liujiajun1993/notes/master/images/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C4-1.png)
<span>差错控制</span>。网络层不控制整个数据包的损坏，而只将校验和加到了数据包中来控制头部的损坏。该字段可能防止两跳之间以及端到端之间的数据报头部的改变或损坏。
无<span>流量控制、拥塞控制</span>

<em>分组交换</em>
网络层中，将来自上层的报文分割成可管理的分组，源端一个一个发送报文，目的端一个一个接受分组。目的端等待所有属于同一个报文的分组到达，再将报文传递到上层。有两种路由分组方法。
- <mark>数据报方法：无连接服务</mark>
  数据报方法中，转发决策基于分组的目的地址，与源地址无关。
  分组头部包含源地址和目的地址。
- <mark>虚电路方法：面向连接服务</mark>
  报文发送前，建立虚连接从而定义数据包的路径。连接建立之后，数据报可以沿着相同的路径发送。
  分组头部不仅包含源地址和目的地址，也必须包含流标号（标签），定义了分组应该经过的路径。
  ![虚电路网络的转发过程](https://raw.githubusercontent.com/liujiajun1993/notes/master/images/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C4-2.png)
  <span>建立阶段</span>
  需要建立从源A到源B的虚拟电路。经过<span>请求分组</span>和<span>确认分组</span>过程（详细过程请见P176，此处不再赘述）。
  请求分组过程中，输出的标签号都未知。
  ![发送请求分组](https://raw.githubusercontent.com/liujiajun1993/notes/master/images/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C4-3.png)
  确认分组过程中，完成了交换表中的表格项。
  ![发送确认分组](https://raw.githubusercontent.com/liujiajun1993/notes/master/images/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C4-4.png)

  <span>数据传输阶段</span>。数据按照建立好的虚电路一个接一个发送。
  <span>拆除阶段</span>。所有分组发送到B之后，A发送一个称为拆除分组的特殊分组，B以确认分组回复，所有路由器从表格中删除响应的项。

<em>网络层性能</em>
网络性能可以通过<span>延迟</span>、<span>吞吐量</span>和<span>分组丢失</span>来衡量
<span>延迟</span> = (n + 1) * (发送延迟 + 传播延迟 + 处理延迟) + n * 排队延迟, n为链路上路由器的数量
<span>吞吐量</span>，该点的数据发送速率。路径的吞吐量，等于路径上所有链路中的最小值。

<span>拥塞控制</span>
  - 开环拥塞控制。发生拥塞之前，采用策略来预防。重传策略、窗口策略、确认策略、丢弃策略、许可策略。
  - 闭环拥塞控制。发生拥塞之后，采用策略来缓解。
      - 背压。发生拥塞的下游结点通知其上游结点降低速率，一个一个一直反向移动到源端。
      - 抑制分组。发生拥塞的结点直接通知源端。
      - 隐含信令。拥塞结点不主动通信，源端从其他相关征兆中察觉出在网络某处存在拥塞。
      - 显式信令。发生拥塞结点发送显式信令通知源端或者目的端发生拥塞。与抑制分组不同，该信号不作为一个单独分组，而是包含在携带数据的分组中。

<em>路由器结构</em>
![路由器元件](https://raw.githubusercontent.com/liujiajun1993/notes/master/images/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C4-5.png)
![输入端口](https://raw.githubusercontent.com/liujiajun1993/notes/master/images/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C4-6.png)

### 4.2 网络层协议
因特网协议第四版(Internet Protocol version 4, IPv4)负责网络层的分组、转发以及传递。因特网控制报文协议第四版(Internet Control Message Protocol, ICMPv4)帮助IPv4处理一些网络层中传递中可能发生的错误。因特网组管理协议(Internet Group Management Protocol, IGMP)用于帮助IPv4多播。地址解析协议(Address Resolution Protocol, ARP)用来将网络和数据链路层联合起来。

<em>IPv4数据报格式</em>
![IP数据报](https://raw.githubusercontent.com/liujiajun1993/notes/master/images/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C4-7.png)

与分段有关的字段：<span>标示identification</span>、<span>标记flag</span>、<span>分段偏移fragmentation offset</span>
<span>标示identification</span>用于识别从源主机发出的数据报，数据报离开源主机时，标示和源IP地址组合必须唯一地定义这个数据报。
<span>标记flag</span>字段定义了三个标记。第一位为保留位（不使用）；第二位为不分段位，如果数值为1，则不能将该数据分段，如果无法通过任何可用物理网络进行传递，则丢弃该分组，并向源主机发送一个ICMP差错报文；第三位为多分段，如果其值为1，标示此数据报不是最后的分段，后续还有更多分段，如果其值为0.标示它是最后一个或唯一地分段。
<span>分段偏移fragmentation offset</span>表示该分段在整个数据报中的相对位置。

<mark>IPv4数据报安全</mark>
IPv4协议没有提供任何安全。容易受到三个安全问题的影响：<span>分组嗅探</span>、<span>分组修改</span>、<span>IP欺骗</span>。
<span>分组嗅探</span>，劫持一个IP分组并拷贝，属于被动攻击，攻击者并不修改分组内容，难以发现。
<span>分组修改</span>，拦截分组，改变内容并将新的分组发送到接收方。可以使用数据完整性机制来发现。
<span>IP欺骗</span>伪装成其他人并创建一个IP分组，携带另一个电脑的源地址。可以使用源鉴别机制预防。

<em>IPv4地址</em>
32位的地址层次结构分为两部分，前缀定义网络，后缀定义代码。
定长前缀称为分类寻址，现已被废止。
![分类寻址地址空间占用](https://raw.githubusercontent.com/liujiajun1993/notes/master/images/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C4-8.png)

分类寻址被废止的原因是地址耗尽

不定长前缀称为无类寻址。无类寻址中如何判断前缀长度？
  - 斜杠标记法： 12.24.76.8/8，前缀长度为8
  - 地址掩码：很复杂，请见P193

因特网名称和编号分配组织（ICANN）将地址分配给ISP。

特殊地址：
- 本地主机地址： 0.0.0.0/32，唯一地址
- 有限广播地址：255.255.255.255/32，唯一地址，当路由器或主机需要向网络中所有设备发送一个数据报时会使用这个地址。
- 回送地址：127.0.0.0/8，如果分组的目的地址是这个块中的某个地址，则不会离开主机。一般用于测试软件。
- 私有地址：10.0.0.0./8、172.016.0.0/12，192.168.0.0/16以及169.254.0.0/16
- 多播地址：224.0.0.0/4

<mark>动态主机配置协议DHCP (Dynamic Host Configuration Protocol)</mark>
DHCP可以将永久IP分配到主机或路由器上，也可以按需为主机提供临时IP地址

![DHCP的运行](https://raw.githubusercontent.com/liujiajun1993/notes/master/images/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C4-9.png)
DHCP报文使用固定的68和67端口，注意客户机第一次发送DHCP报文的源地址和目标地址。
第二步服务器响应中，可以存在多个DHCP服务器的响应报文，客户从中选择最佳地址，在第三步中广播发送告知服务器。
DHCP使用UDP服务。
![DHCP状态](https://raw.githubusercontent.com/liujiajun1993/notes/master/images/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C4-10.png)


<mark>网络地址转换NAT</mark>
![NAT](https://raw.githubusercontent.com/liujiajun1993/notes/master/images/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C4-11.png)

私有网络使用私有地址，看不到因特网其他部分；因特网其他部分只能看到带有地址200.24.5.8的NAT路由器。
所有通过NAT路由器发出去的分组都将分组中的原地址替换为全局NAT地址。所有通过NAT路由器进入的分组都将目的地址替换成合适的私有地址（使用IP地址 + 端口号区别，见下图）
![NAT转换表](https://raw.githubusercontent.com/liujiajun1993/notes/master/images/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C4-11.png)

<em>IP分组的转发</em>
转发，将分组传递到下一个路由器
<span>基于目的地址的转发</span>
面向<span>无连接协议</span>;
基于分组头部的目的地址转发分组;
要求主机或路由器有转发表，通过转发表找到分组的下一跳。
<span>基于标签的转发</span>
面向<span>有连接协议</span>，路由被交换所替代;
交换机基于附加在分组上的标签来路由分组;
路由（无连接）包含了搜索，交换（有连接）包含了访问。

<em>ICMPv4</em>
因特网控制报文协议（Internet Control Message Protocol, ICMP）配合IP协议使用，在进入较低层前，报文被封装到IP数据报中，并将IP数据报的响应协议字段值设为1，表明该IP负载时一个ICMP报文。
<span>差错报告报文</span>
差错报告报文总是发给源端。
差错报文包含一个数据部分，包含了原始数据报的IP头部，加上数据报中前8个字节的数据（提供了关于端口号和序号的信息）。
目的端不可达报文、源端抑制报文、重定向报文、超时报文、参数问题报文。

<span>查询报文</span>
用于检测主机或路由器是否处于活跃状态，也用于获取两台设备之间IP数据报的单向或往返时间，甚至用于检查两台设备之间的始终是否同步。
<span>回送请求</span>和<span>回送应答</span>报文用于检测主机或路由器是否处于活跃状态。常见应用<span>ping</span>和<span>traceroute</span>
<span>时间戳请求</span>和<span>时间戳应答</span>

<article>
<span>ping</span>从两条查询报文中获得帮助
<span>traceroute</span>则从两条差错报告报文中获得帮助：超时报文和目的端不可达报文。traceroute被封装到UDP用户数据报中，但traceroute有意使用一个目的端不可用的端口号。如果路径上有n个路由器，则traceroute程序发送 n+1 次报文，每次都获得一个新路由器的IP地址。每个路由器 + 目的主机都丢弃一个报文。路由器发送超时报文，目的主机发送目的端不可达报文。
</article>

### 4.3 单播路由选择
网络层目的是从源端向一个或多个目的端传递数据报。
- 一对一传递：单播路由选择（unicast routing)
- 一对多传递：多播路由选择
- 一对所有：广播路由选择

<em>基本思想</em>
最小代价路由
<span>最小代价树</span>，可以根据动态规划思想建立，Dijkastra算法

<mark>路由选择算法</mark>
<span>距离向量路由选择</span>。每个结点根据自身对于邻接结点的信息来建立最小代价树，不完全树在临站之间交换使得树越来越完整，不断更新互联网中所有结点之间的最短路径。<span>每个路由器向邻居告知所知道的所有关于整个互联网的信息。</span>
<span>链路状态路由选择</span>。创建一个链路状态数据库（LSDB），整个互联网只有一个LSDB。建立LSDB通过泛洪进行。所有结点向邻接结点发送报文，收集邻居机械能系。<span>每个路由器向邻居告知所知道的关于邻居的信息。</span>
<span>路径向量路由选择</span>。允许路由在分组时采用特殊策略，例如经过不安全的路由器。不采用最小代价树，采用最佳生成树。

<mark>路由选择协议</mark>
<span>路由选择信息协议。</span>基于距离向量路由选择。在自治系统内部使用的域内路由选择协议。路由代价使用<span>跳数</span>来表示。RIP使用UDP服务和熟知端口520。
<span>开放最短路径优先。</span>基于链路状态路由选择。域内路由选择算法。可以选择跳数、流量、往返时间等作为代价衡量。由于在大型自治系统中泛洪流量过大，因此可以先将整个网路分为若干个区域。
<span>边界网关协议。</span>基于路径向量路由选择。互联网中唯一一个域间路由选择协议。

### 4.4 多播路由选择
<em>暂时跳过</em>

### 4.5 IPv6
- 更大的地址空间
- 更好的头部格式。将选项与基本头部分开，简化了路由选择过程。
- 新的选项
- 允许扩展
- 支持资源分配
- 支持更多安全性

<mark>分组格式</mark>
![IPv6分组格式](https://raw.githubusercontent.com/liujiajun1993/notes/master/images/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C4-13.png)
- 版本：6
- 流量类：区分不同传递要求的不同有效载荷。代替IPv4中的服务类型
- 流标号：对特殊数据进行专门处理
- 有效载荷长度：不包含基本头部的IP数据报总长度。IPv4中，有两个字段：报头长度和总长度。但在IPv6中，头部长度固定为40字节，因此只需要定义有效载荷长度。
- 下一个头部：第一个扩展头部的类型（如果存在）或数据报中跟随在基本头部之后的头部。。。
- 跳数限制
- 源地址和目的地址
- 有效载荷。0个或多个扩展头部（选项）的组合，紧随其后的是来自其他协议（UDP、TCP等）的数据。
![有效载荷示意图](https://raw.githubusercontent.com/liujiajun1993/notes/master/images/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C4-14.png)

<span>流</span>。流标号加入头部之后，允许我们将IPv6作为面向连接的协议。对于路由器，流是共享某些特性的分组序列。流标号可以用来加入路由器对分组的处理，很容易在流标号中找到下一跳地址而不需要去路由表中查或者使用算法计算。还可以支持实时视频音频传输。

<span>分段和重组</span>。IPv6所有的分段都在源端进行，重组都在目的端进行。不允许路由器对分组进行分段。

<span>扩展头部</span>。非常重要。尤其是三个：分段、鉴别、扩展的加密安全有效载荷字段。

<mark>IPv6寻址</mark>
两种地址表示方法
-  二进制表示法(128位)
-  冒号十六进制（8个部分，每个部分4个十六进制数字）。

三种地址类型
- 单播（一对一）
- 任播（一组计算机共享一个地址，分组只被传递到最容易到达的一个成员）
- 多播（一组计算机，每个成员都接受一个副本）

<em>从IPv4过渡到IPv6</em>
<mark>双协议栈</mark>。一个站点同时运行两个版本。分组到达目的端时，主机向DNS查询确认时IPv4还是IPv6。
<mark>隧道</mark>。两台使用IPv6的计算机通信时，分组要通过使用IPv4的区域，则使用隧道技术。进入隧道时，IPv6封装成IPv4，离开时再解封。
<mark>头部转换</mark>。发送方是IPv6，但接收方只能识别IPv4。使用头部转换为IPv4.
![策略示意图](https://raw.githubusercontent.com/liujiajun1993/notes/master/images/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C4-15.png)

<em>ICMPv6</em>
![网络层版本区别](https://raw.githubusercontent.com/liujiajun1993/notes/master/images/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C4-16.png)
ICMP、ARP以及IGMPv4合并到ICMPv6

<mark>报文</mark>
<span>差错报文</span>
取消了源端抑制报文。
- 目的端不可达报文
- 分组过大
- 时间超时
- 参数问题

<span>请求报文</span>
<span>邻居发现报文</span>
- 路由器请求、路由器通告用于找到默认路由器，取代DHCP协议
- 邻居请求、邻居通告试图发现主机或路由器的链路层地址，取代ARP协议
- 重定向报文与第四版相同
- 逆向邻居请求、逆向邻居通告报文用来找出主机或路由器的IPv6地址

<span>组成员关系报文</span>。成员关系请求报文和成员关系报告报文用于多播，取代IGMP报文

-----
## 五、数据链路层：有线网络
<span>链路层地址是指MAC地址</span>
### 5.1 介绍
<em>结点和链路</em>
主机和路由器视为结点，源端和目的端之间的网络视为链路
<em>两类链路</em>
点对点链路（两个设备独占使用）、广播链路（几对设备共享）
<em>两个子层</em>
数据链路控制（DLC）和介质访问控制（MAC）。介质访问控制子层为广播链路独有。
![数据链路层的两个子层](https://raw.githubusercontent.com/liujiajun1993/notes/master/images/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C5-1.png)

### 5.2 数据链路控制
数据链路控制处理两个临近结点的通信过程。功能包括成帧、流量控制和差错控制（差错检测、差错纠正）。

<em>成帧</em>
- 面向字符成帧。只能用于ASCII字符编码系统，在帧的开始和结尾处添加flag以分离帧
- 面向位成帧。使用特殊的8位模式标记01111110作为分界符。数据段为一个为序列。

<em>流量控制</em>
在接收确认前调整能够发送的数据数量。思想和传输层的思想遵循相同的原则。

<em>差错控制</em>
每次一个帧通过链路，都需要确认这个帧没有出错。
差错类型：单个位差错、突发性差错（多个位差错）
<mark>冗余</mark>，额外的位，由发送方添加，由接收方移除，从而允许接收方检测或纠正被破坏的位。
<mark>编码</mark>
通过编码实现冗余。分为块编码和卷积编码
<span>块编码</span>
将报文分块，每块k位，成为数据字（dataword），每块增加r个冗余位，形成的n=k+r位块称为代码字。
块编码中进行差错检测的方法：
1. 接受方有一张有效代码表
2. 原始代码字已经无效

例如，下图是一张编码表。接收方接收到011，则提取数据字01；接收方收到111，说明传输过程中代码字被破坏。
但是，如果发送方发送011，传输过程中变为000，接收方将错误地提取数据字00。<span>两个</span>破坏的位使得差错无法检测。
因此需要定义最小汉明距离（汉明距离指对应为的值不同的数量，即011与000汉明距离为2）
![块编码表](https://raw.githubusercontent.com/liujiajun1993/notes/master/images/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C5-2.png)

<span>如果传输过程中有s个差错发生，那么发送的代码字和接受的代码字之间的汉明距离就是s。此时需要保证所有有效代码字之间的最小距离是**(s+1)**，那么能够保证所有的差错都能够检测出来。

即，为了保证能够检测出所有情况下的多达s个差错，在块编码中的最小汉明距离必须是 d = s + 1. </span>

<span>线性块编码</span>
线性块编码由两个有效代码字执行异或运算产生另一个有效代码字。
线性编码的最小汉明距离是具有最小的1的个数的非0有效代码字中1的个数（非0的最少1的个数）
<span>循环编码</span>
代码字循环移位产生另一个代码字
<span >校验和</span>

<em>两种DLC协议</em>
<mark>HDLC(高级数据链路控制)</mark>。面向位的协议，实现了停止等待协议。
![HDLC帧](https://raw.githubusercontent.com/liujiajun1993/notes/master/images/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C5-3.png)

- 标记域。指明一个帧的开始和结束。
- 地址域。包含从站的地址。
- 控制域。进行流量控制和差错控制。
- 信息域。来自网络层的用户数据或管理信息。
- 帧校验序列。HDLC的差错检验域。

<mark>点到点协议 (PPP, Point-to-Point Protocol)</mark>。用户通过该协议将家庭电脑域ISP服务器连接起来。
PPP定义了两条设备之间如何协商链路的建立和数据的转发，提供了认证和多重链路的链接，提供网络地址的配置。
但不提供流量控制，差错控制非常简单。
![PPP帧](https://raw.githubusercontent.com/liujiajun1993/notes/master/images/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C5-4.png)

PPP面向字节

PPP使用另外的协议来建立链路，认证双方，承载数据
- 链路控制协议（LCP），负责建立、维护、配置和终止链路，也提供给了两终端协商机制
- 2个认证协议（AP）
  - 口令认证协议（Password Authentication Protocol, PAP)
  - 查询握手认证协议(Challenge Handshake Authentication Protocol, CHAP)，三步握手认证，比PAP更安全，因为用户口令只用来加密和解密，并不在线上传播。
- 网络控制协议

### 5.3 多路访问协议
与其他用户共享有线或无线介质，需要一个协议来管理共享过程。
![多路访问协议分类](https://raw.githubusercontent.com/liujiajun1993/notes/master/images/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C5-5.png)

<em>随机访问/竞争访问</em>
没有站点优于其他站点，没有站点可以控制其他站点。
- 站点传输是随机的，没有特定时间
- 站点传输是竞争的，没有规则来规定下一个将要发送的站点是哪一个。

这样会出现冲突碰撞，有帧会被破坏或修改。

<mark>ALOHA</mark>

载波监听多路访问，要求每一个站点在发送前先监听介质，“先监听后传输”

- 带冲突检测的载波监听多路访问CSMA/CD，站点在发送帧后监视介质来查看输出是否成功。一旦监听到冲突，立即停止传输。
- 带冲突避免的载波侦听多路访问CSMA/CA，请见第6章。

<em>受控访问</em>
站点之间相互协商以确定哪一个站点有权发送帧。如果一个站点没有其他站点授权，则不能发送帧。
三种受控访问方法。
<mark>预约</mark>
时间被分为时隙，每个时隙中，数据帧发送前先发送一个预约帧。
如果系统中有N个站点，在预约帧中就有N个预约字时隙，站点在自己的子时隙中预约，然后发送数据帧。
<mark>轮询</mark>
一个设备做主站，其他设备做从站，所有的数据交换必须通过主站。
主站决定哪一个设备使用通道，因此主站总是会话的发起者。
当主站准备接收数据时，依次询问每个设备是否需要发送数据；
当主站要发送数据时，通知从站准备接收。
<mark>通道化</mark>
请见第6章。

### 5.4 链路层寻址
网络层中使用IP地址定义源主机和目的主机。但链路层中无法单单使用IP地址，因为数据报可能经过不同的路径。
传输过程中，IP地址不变，但是当帧从一个链路移动到另一个链路时，两个链路层地址（源地址-目的地址）就要发生变化。
![链路层传输的地址变化](https://raw.githubusercontent.com/liujiajun1993/notes/master/images/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C5-6.png)

<mark>地址解析协议(ARP, Address Resolution Protocol)</mark>
<span>在网络层中，一个结点要向链路上另一个结点发送IP数据报，都有接受结点的IP地址：源主机知道默认路由器的IP地址，路由器通过转发表获取下一个路由器的IP地址，最后的路由器知道目的主机的IP地址。
而IP地址对于帧在链路层上的移动没有帮助，此时需要ARP协议。
主机或者路由器需要查询网络中另一台主机或路由器的链路层地址时，发送ARP请求分组，包含发送方的链路层地址、发送方IP地址和接收方的IP地址。该查询请求通过广播查询。
每一台主机或路由器都接受和处理ARP请求分组，但只有预订的接收方识别其IP地址，并发挥一个ARP响应分组，包含接收方的IP地址和链路层地址。该响应分组为单播。</span>

![ARP分组](https://raw.githubusercontent.com/liujiajun1993/notes/master/images/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C5-7.png)

<article>
<header>**访问网页时，所有主机和路由器的活动**</header>
<mark>客户端活动</mark>
1. 应用层：用户在HTTP客户端输入URL。HTTP客户端不知道对应站点的IP地址，因此调用<span>DNS</span>的客户端，向DNS服务器发送请求，并查询网站的<span>IP地址</span>，地址传递给传输层
2. 传输层：使用HTTP客户端分配的临时端口，以及熟知端口80创建<span>报文段</span>。然后传递给网络层
3. 网络层：接受报文段以及对方站点IP地址。然后查询它的路由表，并试图查询到达目的地的下一个路由器的IP地址。此地址为网络层地址，但是还需要下一个路由器的链路层地址。网络层使用<span>ARP</span>来查询<span>链路层地址</span>，将数据报和链路层地址传输给数据链路层
4. 数据链路层：知道自己的链路层地址和下一个路由器的链路层地址，创建<span>帧</span>并将帧传递给物理层
5. 物理层：转换为<span>信号</span>，并通过介质发送。
![客户端活动](https://raw.githubusercontent.com/liujiajun1993/notes/master/images/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C5-8.png)

<mark>路由器活动</mark>
路由器没有应用层和传输层
1. 物理层1：接受信号，并创建帧传递给数据链路层
2. 数据链路层1：解封得到数据报，将其传递给网络层
3. 网络层：检查数据报的网络层地址，得到目的主机的IP地址。通过查询路由表，找到下一个结点的IP地址，并通过ARP查询得到下一个路由器的丽娜路层地址
4. 数据链路层2：重新根据数据链路层地址封装帧，并传递给物理层
5. 物理层2：编码为信号，通过介质传递给下一个路由器
![路由器活动](https://raw.githubusercontent.com/liujiajun1993/notes/master/images/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C5-9.png)
<i>该图有误，最下面应该都为物理层。</i>

<mark>目的站点活动</mark>
1. 同上
2. 同上
3. 同上
4. 传输层拆封报文段，并将其传递给端口80。
5. HTTP服务器接收到报文，响应请求。
6. 请求内容按照反序传递给客户端。
![目标站点活动](https://raw.githubusercontent.com/liujiajun1993/notes/master/images/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C5-10.png)
</article>

### 5.5 有线局域网：以太网协议
几乎除以太网以外的其他局域网都从市场上消失了，因为以太网协议能够演变以适应高传输速率的要求。

<mark>标准以太网</mark>
传输速率为10Mbps。
![以太网帧](https://raw.githubusercontent.com/liujiajun1993/notes/master/images/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C5-11.png)

标准以太网使用1-持续方法的CSMA/CD，当站点监测到介质空闲时就开始发送帧。
<mark>快速以太网</mark>100Mbps
<mark>千兆以太网</mark>1Gbps
<mark>10千兆以太网</mark>10Gbps

<mark>虚拟局域网</mark>虚拟局域网将属于一个或多个物理局域网的站点分为多个广播域，使得站点之间彼此通信好像属于一个物理分段一样。

### 5.6 其他有线网络
<em>点对点网络</em>
诸如拨号、DSL和电缆来提供互联网接入。两个设备之间使用一个专用链接，因此不需要使用介质访问控制，只需要PPP协议即可。

<em>SONET</em>

<em>异步传输模式ATM</em>

### 5.7 连接设备
<mark>中继器或集线器</mark>
在信号帅见到维基数据完整性之前，重新生成以及重新定时原始位模式。
只工作在物理层。
中继器没有过滤能力。
中继器或集线器没有链路层地址，不检查接收到的帧的链路地址

<mark>链路层交换机</mark>
工作在物理层和数据链路层。
作为物理层设备，重新生成接收到的信号；作为链路层设备，检查包含在帧中的MAC地址。
链路层交换集有过滤能力。
链路层交换机不改变链路层地址。

<mark>路由器</mark>
工作在物理层、数据链路层和网络层。
作为物理层设备，重新生成接收到的信号；作为链路层设备，检查包含在帧中的MAC地址；作为网络层设备，检查网络层地址。
路由器改变分组中的链路层地址。

-----
## 六、无线网络和移动IP
### 6.1 无线局域网
与有线局域网的<span>区别</span>：
- 介质：从电缆编程空气，信号为广播，多路访问
- 主机：无线网络中主机不必物理地连接至网络，可以自由地移动
- 隔离局域网
- 连接至其他网络

<span>特性</span>：
- 衰减更快
- 干扰更强
- 多路径广播，存在反射信号
- 差错更多

<em>MAC子层</em>
![MAC层](https://raw.githubusercontent.com/liujiajun1993/notes/master/images/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C5-12.png)

<mark>分布式协调功能（DCF）</mark>
<span>CSMA/CA</span>避免冲突的载波侦听多路访问。因为在无线网络中，冲突不能被检测到，所以不能使用CSMA/CD
- 帧间隔。当一个控线通道被发现，站点也不立即发送，而是等待一个帧间隔，如果通道仍是空闲，那么就可以发送了，但是需要等待一段竞争时间。
- 竞争窗口。准备发送的站点选择随机数目的时隙作为等待时间。每一个时隙之后站点都检测通道，如果通道忙就停止定时器；等监测到通道空闲时就重启定时器
- 确认。正式确认和超时定时器。
![CSMA/CA的流程图](https://raw.githubusercontent.com/liujiajun1993/notes/master/images/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C5-13.png)

<span>网络分配适量NAV（network allocation vector）</span>
每当站点要发送数据，帧中包含需要占用通道的时间。受该传输影响的站点创建一个NAV的定时器。站点在检查介质是否空闲前，先检查自己的NAV是否过期（未过期肯定说明还有站点在传输数据）

<span>握手</span>
![CSMA/CA和NAV](https://raw.githubusercontent.com/liujiajun1993/notes/master/images/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C5-14.png)
源主机发送RTS帧和目的主机响应CTS帧的过程称为握手周期。

<mark>点协调功能（PCF）</mark>
在DCF上实现，主要用于对时间敏感的传输。
采用集中式的、无竞争的轮询访问方式。AP(访问点，无线网络与有线网络的连接点，一般为无线路由器)对站点进行轮询，站点依次发送数据。

<em>帧格式</em>
![帧格式](https://raw.githubusercontent.com/liujiajun1993/notes/master/images/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C5-15.png)
帧类型： 管理帧、控制帧、数据帧

<em>蓝牙</em>
蓝牙局域网是一种自组织网络，网络是自发形成的。


P336